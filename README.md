# Jiminy Desktop App

Menu bar app shell for Jiminy (macOS only).

## Run

```bash
npm install
npm start
```

## Tests

```bash
npm test
```

## E2E Tests (Playwright)

```bash
npm run test:e2e
```

E2E helpers:

-   `JIMINY_E2E=1` opens the Settings window on launch and bypasses native dialogs.
-   `JIMINY_E2E_CONTEXT_PATH` supplies the folder picker result.
-   `JIMINY_SETTINGS_DIR` overrides the settings storage directory.
-   `JIMINY_LLM_MOCK=1` replaces Gemini calls with a mock summarizer.
-   `JIMINY_LLM_MOCK_TEXT` sets the mock summary text (default: `gibberish`).
-   On Linux CI/E2E runs (`JIMINY_E2E=1` or `CI=true`), the app disables GPU and sandbox flags to improve launch reliability.

## Run GitHub CI locally

Use `act` from the repo root to run the CI job:

```bash
act -W .github/workflows/ci.yml -s LLM_API_KEY=YOUR_KEY
```

## GitHub CI (exact run details)

CI runs on `ubuntu-latest` with Node.js 20 and uses the `code/desktopapp` working directory. Steps:

```bash
npm ci
npx playwright install --with-deps
npm test
xvfb-run --auto-servernum -- npm run test:e2e
```

Environment:

- `CI=true`
- `LLM_API_KEY` from GitHub secrets (used by unit tests)
- E2E tests also launch Electron with `--no-sandbox --disable-gpu --disable-dev-shm-usage` on Linux/CI.
  - `--no-sandbox`: required in many CI/container setups where the Chromium sandbox cannot initialize (no user namespaces).
  - `--disable-gpu`: avoids GPU initialization failures under Xvfb/headless Linux.
  - `--disable-dev-shm-usage`: avoids crashes when `/dev/shm` is tiny in containers (uses disk instead).

## Notes

-   The app runs from the macOS menu bar with a Settings window that stores the Context Folder Path and LLM API key in `~/.jiminy/settings.json`.
-   The Settings window includes a Context Graph sync action that writes summaries to `~/.jiminy/context-tree.json`.
-   Auto-launch on login is enabled via Electron login item settings.
-   The tray menu includes a **Capture Selection** overlay (drag to select, release to capture) that saves a PNG to `<contextFolderPath>/jiminy-captures`. It requires macOS Screen Recording permission in **System Settings > Privacy & Security > Screen Recording**.
-   A global hotkey triggers the same capture flow: `Command+Shift+J` on macOS (Electron accelerator `CommandOrControl+Shift+J`).
-   Captures enqueue a background extraction task (`sourceType: "image"`) which runs the Gemini Vision extractor and writes a Markdown file next to the PNG as `<capture>.png-extraction.md`. Extraction is skipped if no API key is configured and mocking is disabled.

## Context Graph (Current Implementation)

-   **Source of truth:** The Context Folder Path saved in `~/.jiminy/settings.json`.
-   **Scan scope:** Recursively walks the context folder and only includes `.md` and `.txt` files. Other files are skipped with a log entry.
-   **Capture exclusions:** The `jiminy-captures` folder under the context root is ignored during scans.
-   **Analysis exclusions:** Any folder whose name ends with `jiminy-extra-context` is ignored during scans.
-   **Cycle safety:** Keeps a visited set of resolved directory paths and warns when a cycle is detected (including symlink loops).
-   **Node limit:** Hard cap of 100 nodes (folders + files). Sync fails with an error if exceeded.
-   **Summaries:** File summaries are generated by the LLM; folder summaries are generated by summarizing file summaries.
-   **Caching:** File summaries are reused only if the file content hash matches _and_ the cached summary is non‑empty.
-   **Output:** Writes a single JSON graph to `~/.jiminy/context-tree.json` with nodes keyed by stable ids.

## Context Graph Dev Notes

-   **LLM config:** Uses the API key saved in `~/.jiminy/settings.json` under `llm_provider.api_key` (configure it in the Settings window). For tests or local runs, set `JIMINY_LLM_MOCK=1` (optionally `JIMINY_LLM_MOCK_TEXT`) to bypass live calls.
-   **IPC surface:** Main process exposes `contextGraph:sync` and streams progress via `contextGraph:progress`. Renderer subscribes through `window.jiminy.onContextGraphProgress`.
-   **Schema reference:** See `code/desktopapp/context-graph/nodes.js` for node fields and `code/desktopapp/context-graph/sync.js` for the graph root shape.
-   **Errors vs warnings:** Sync returns `errors` (fatal issues like unreadable files or empty LLM responses) and `warnings` (cycle detections). Renderer shows warnings but allows completion.
-   **Tests:** `code/desktopapp/test/llms.test.js` makes a live Gemini call and will fail without a network connection and a valid `LLM_API_KEY` in the environment.

## Example Context Graph

```json
{
  "version": 1,
  "rootPath": "/Users/example/context",
  "generatedAt": "2026-01-19T13:51:11.637Z",
  "model": "gemini-1.5-flash",
  "rootId": "n_19ec2fb35088",
  "counts": { "files": 1, "folders": 1 },
  "nodes": {
    "n_19ec2fb35088": {
      "id": "n_19ec2fb35088",
      "type": "folder",
      "name": "context",
      "relativePath": "",
      "summary": "High-level overview of the context folder.",
      "summaryUpdatedAt": "2026-01-19T13:51:11.637Z",
      "children": ["n_9f5b84d1a86b"]
    },
    "n_9f5b84d1a86b": {
      "id": "n_9f5b84d1a86b",
      "type": "file",
      "name": "README.md",
      "relativePath": "README.md",
      "summary": "Summary of the README contents.",
      "summaryUpdatedAt": "2026-01-19T13:51:10.123Z",
      "sizeBytes": 1024,
      "modifiedAt": "2026-01-18T10:00:00.000Z",
      "contentHash": "2d32b5591b300d8407c94f12abcd5c6e4412883915d6b0a8b5ae3b6203b30abe"
    }
  }
}
```

## License

[CC0 1.0 (Public Domain)](LICENSE.md)

## Architecture Overview

```
                           ┌─────────────────────────────┐
                           │         Menu Bar Tray        │
                           └──────────────┬──────────────┘
                                          │
                      ┌───────────────────┴───────────────────┐
                      │                                       │
                      ▼                                       ▼
           ┌─────────────────────┐                 ┌──────────────────────┐
           │    Settings Window  │                 │   Capture Selection  │
           └──────────┬──────────┘                 └──────────┬───────────┘
                      │                                       │
                      ▼                                       ▼
           ┌─────────────────────┐                 ┌──────────────────────┐
           │ ~/.jiminy/settings  │                 │   Capture Overlay     │
           └──────────┬──────────┘                 └──────────┬───────────┘
          ┌───────────┴───────────┐                            │
          │                       │                            ▼
          ▼                       ▼                 ┌──────────────────────┐
┌──────────────────┐   ┌──────────────────┐        │ PNG saved to           │
│ Context Folder   │   │ LLM API Key      │        │ <context>/jiminy-      │
└──────────┬───────┘   └──────────────────┘        │ captures/*.png         │
           │                                       └──────────┬───────────┘
           │                                                  │
           │                                                  ▼
           │                                       ┌──────────────────────┐
           │                                       │ extractionQueue       │
           │                                       │ enqueue:              │
           │                                       │ { sourceType: image,  │
           │                                       │   metadata: { path } }│
           │                                       └──────────┬───────────┘
           │                                                  │
           ▼                                                  ▼
┌──────────────────────┐                          ┌──────────────────────┐
│ Context Graph Sync   │                          │ Image Extraction      │
│ (ignores jiminy-     │                          │ Handler               │
│  captures folder)    │                          └──────────┬───────────┘
└──────────┬───────────┘                                     │
           │                                                  ▼
           ▼                                       ┌──────────────────────┐
┌──────────────────────┐                          │ Gemini Vision API     │
│ Gemini Text Summarizer│                          └──────────┬───────────┘
└──────────┬───────────┘                                     │
           ▼                                                  ▼
┌──────────────────────┐                          ┌──────────────────────┐
│ ~/.jiminy/context-   │                          │ <capture>.png-        │
│ tree.json            │                          │ extraction.md         │
└──────────┬───────────┘                          └──────────┬───────────┘
           │                                                  │
           │                                                  ▼
           │                                       ┌──────────────────────┐
           │                                       │ analysisQueue         │
           │                                       │ enqueue:              │
           │                                       │ { result_md_path }    │
           │                                       └──────────┬───────────┘
           │                                                  │
           │                                                  ▼
           │                                       ┌──────────────────────┐
           │                                       │ Analysis Handler      │
           │                                       └──────────┬───────────┘
           │                                                  │
           ▼                                                  ▼
┌──────────────────────┐                          ┌──────────────────────┐
│ Context Graph Nodes  │                          │ <analysis>.md saved   │
│ (root or node-level  │                          │ to root or <node>-    │
│  extra context)      │                          │ jiminy-extra-context  │
└──────────────────────┘                          └──────────────────────┘
```


tests:
- if image is empty, show user that permissions are still an issue
- context graph should ignore captures folder
- context graph should ignore `*-jiminy-extra-context` folders
